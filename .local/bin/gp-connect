#!/bin/sh

HAS_GUM=0
command -v gum >/dev/null 2>&1 && HAS_GUM=1

banner() {
    echo ""
    if [ "$HAS_GUM" = "1" ]; then
        gum style --border rounded --padding "0 2" --border-foreground 99 --foreground 255 --bold "$1"
    else
        echo "=== $1 ==="
    fi
    echo ""
}

spin() {
    if [ "$HAS_GUM" = "1" ]; then
        gum spin --spinner dot --title "$1" -- sh -c "$2"
    else
        echo "$1"
        sh -c "$2"
    fi
}

success() {
    if [ "$HAS_GUM" = "1" ]; then
        gum style --foreground 78 --bold "âœ“ $1"
    else
        echo "âœ“ $1"
    fi
}

error() {
    if [ "$HAS_GUM" = "1" ]; then
        gum style --foreground 196 "âœ— $1"
    else
        echo "âœ— $1"
    fi
}

VERBOSE=0
for arg in "$@"; do
    case "$arg" in
        -v|--verbose) VERBOSE=1 ;;
    esac
done

if [ "$(id -u)" = "0" ]; then
    error "Run without sudo. The script handles sudo internally."
    exit 1
fi

banner "ðŸ” GlobalProtect VPN"

CREDS_FILE=$(mktemp)
spin "Fetching credentials..." "
    op read 'op://Dats.Team/slblumzoqj5kpjjqpzcgg5vsem/username' >> $CREDS_FILE
    op read 'op://Dats.Team/slblumzoqj5kpjjqpzcgg5vsem/password' >> $CREDS_FILE
    op read 'op://Dats.Team/slblumzoqj5kpjjqpzcgg5vsem/one-time password?attribute=otp' >> $CREDS_FILE
    op read 'op://Dats.Team/slblumzoqj5kpjjqpzcgg5vsem/sudo' >> $CREDS_FILE
"
USER=$(sed -n '1p' "$CREDS_FILE")
PASS=$(sed -n '2p' "$CREDS_FILE")
OTP=$(sed -n '3p' "$CREDS_FILE")
SUDO_PASS=$(sed -n '4p' "$CREDS_FILE")
rm -f "$CREDS_FILE"
URL="vpn.itdept.team"
success "Credentials loaded"

EXPECT_SCRIPT=$(mktemp)
cat > "$EXPECT_SCRIPT" << EOF
spawn sudo openconnect --protocol=gp --background --pid-file=/tmp/openconnect.pid --user=$USER $URL

expect "Password:"
send "$SUDO_PASS\r"

expect -re "Password:|password:"
send "$PASS\r"

expect "Challenge:"
send "$OTP\r"

expect eof
EOF

if [ "$VERBOSE" = "1" ]; then
    expect "$EXPECT_SCRIPT"
elif [ "$HAS_GUM" = "1" ]; then
    gum spin --spinner dot --title "Connecting..." -- expect -f "$EXPECT_SCRIPT"
else
    echo "Connecting..."
    expect "$EXPECT_SCRIPT"
fi
rm -f "$EXPECT_SCRIPT"

success "Connected"
echo ""
