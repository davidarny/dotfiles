#!/bin/sh

HAS_GUM=0
command -v gum >/dev/null 2>&1 && HAS_GUM=1

banner() {
    echo ""
    if [ "$HAS_GUM" = "1" ]; then
        gum style --border rounded --padding "0 2" --border-foreground 99 --foreground 255 --bold "$1"
    else
        echo "=== $1 ==="
    fi
    echo ""
}

spin() {
    if [ "$HAS_GUM" = "1" ]; then
        gum spin --spinner dot --title "$1" -- sh -c "$2"
    else
        echo "$1"
        sh -c "$2"
    fi
}

success() {
    if [ "$HAS_GUM" = "1" ]; then
        gum style --foreground 78 --bold "âœ“ $1"
    else
        echo "âœ“ $1"
    fi
}

error() {
    if [ "$HAS_GUM" = "1" ]; then
        gum style --foreground 196 "âœ— $1"
    else
        echo "âœ— $1"
    fi
}

PID_FILE="/tmp/openconnect.pid"

banner "ðŸ” GlobalProtect VPN"

if [ ! -f "$PID_FILE" ]; then
    error "No VPN connection found"
    echo ""
    exit 1
fi

CREDS_FILE=$(mktemp)
spin "Fetching credentials..." "op read 'op://Dats.Team/slblumzoqj5kpjjqpzcgg5vsem/sudo' > $CREDS_FILE"
SUDO_PASS=$(cat "$CREDS_FILE")
rm -f "$CREDS_FILE"

spin "Disconnecting..." "echo '$SUDO_PASS' | sudo -S kill \$(cat '$PID_FILE') 2>/dev/null; echo '$SUDO_PASS' | sudo -S rm -f '$PID_FILE' 2>/dev/null"

success "Disconnected"
echo ""
